// agriculture-app.js - Aplicativo de Agronomia para GitHub

// Classe principal do aplicativo
class AgricultureApp {
  constructor() {
    this.crops = [];
    this.weatherData = null;
    this.soilTypes = ['Argiloso', 'Arenoso', 'Humoso', 'Calcário', 'Misto'];
    this.init();
  }

  // Inicializa o aplicativo
  init() {
    this.loadSampleData();
    this.setupEventListeners();
    console.log('Aplicativo de Agronomia iniciado!');
  }

  // Carrega dados de exemplo
  loadSampleData() {
    this.crops = [
      { id: 1, name: 'Milho', season: 'Verão', growthDays: 90, soilType: 'Argiloso', waterNeeds: 500 },
      { id: 2, name: 'Soja', season: 'Verão', growthDays: 120, soilType: 'Arenoso', waterNeeds: 450 },
      { id: 3, name: 'Trigo', season: 'Inverno', growthDays: 150, soilType: 'Humoso', waterNeeds: 600 },
      { id: 4, name: 'Feijão', season: 'Primavera', growthDays: 75, soilType: 'Misto', waterNeeds: 350 }
    ];
  }

  // Configura os ouvintes de eventos
  setupEventListeners() {
    document.getElementById('search-btn')?.addEventListener('click', () => this.searchCrop());
    document.getElementById('calculate-btn')?.addEventListener('click', () => this.calculateWater());
    document.getElementById('add-crop-btn')?.addEventListener('click', () => this.showAddCropForm());
  }

  // Pesquisa por cultivos
  searchCrop() {
    const searchTerm = document.getElementById('crop-search').value.toLowerCase();
    const results = this.crops.filter(crop => 
      crop.name.toLowerCase().includes(searchTerm) || 
      crop.season.toLowerCase().includes(searchTerm) ||
      crop.soilType.toLowerCase().includes(searchTerm)
    );
    
    this.displayResults(results);
  }

  // Exibe resultados da pesquisa
  displayResults(results) {
    const resultsDiv = document.getElementById('results');
    if (!resultsDiv) return;
    
    if (results.length === 0) {
      resultsDiv.innerHTML = '<p>Nenhum cultivo encontrado.</p>';
      return;
    }
    
    resultsDiv.innerHTML = results.map(crop => `
      <div class="crop-card">
        <h3>${crop.name}</h3>
        <p><strong>Época:</strong> ${crop.season}</p>
        <p><strong>Dias para colheita:</strong> ${crop.growthDays}</p>
        <p><strong>Tipo de solo:</strong> ${crop.soilType}</p>
        <p><strong>Necessidade hídrica (mm):</strong> ${crop.waterNeeds}</p>
      </div>
    `).join('');
  }

  // Calcula necessidade de água para área
  calculateWater() {
    const area = parseFloat(document.getElementById('area-input').value);
    const cropSelect = document.getElementById('crop-select');
    const cropId = parseInt(cropSelect.value);
    const selectedCrop = this.crops.find(crop => crop.id === cropId);
    
    if (!selectedCrop || isNaN(area)) {
      alert('Por favor, selecione um cultivo e insira uma área válida.');
      return;
    }
    
    const waterNeeded = (selectedCrop.waterNeeds * area).toFixed(2);
    document.getElementById('water-result').innerText = 
      `Água necessária: ${waterNeeded} mm para ${area} hectares de ${selectedCrop.name}`;
  }

  // Mostra formulário para adicionar novo cultivo
  showAddCropForm() {
    const formHtml = `
      <div id="add-crop-form">
        <h3>Adicionar Novo Cultivo</h3>
        <form id="new-crop-form">
          <div>
            <label>Nome:</label>
            <input type="text" id="new-crop-name" required>
          </div>
          <div>
            <label>Época:</label>
            <select id="new-crop-season" required>
              <option value="Primavera">Primavera</option>
              <option value="Verão">Verão</option>
              <option value="Outono">Outono</option>
              <option value="Inverno">Inverno</option>
            </select>
          </div>
          <div>
            <label>Dias para colheita:</label>
            <input type="number" id="new-crop-days" required>
          </div>
          <div>
            <label>Tipo de solo:</label>
            <select id="new-crop-soil" required>
              ${this.soilTypes.map(type => `<option value="${type}">${type}</option>`).join('')}
            </select>
          </div>
          <div>
            <label>Necessidade hídrica (mm):</label>
            <input type="number" id="new-crop-water" required>
          </div>
          <button type="submit">Salvar</button>
          <button type="button" id="cancel-add">Cancelar</button>
        </form>
      </div>
    `;
    
    document.getElementById('forms-container').innerHTML = formHtml;
    
    document.getElementById('new-crop-form').addEventListener('submit', (e) => {
      e.preventDefault();
      this.addNewCrop();
    });
    
    document.getElementById('cancel-add').addEventListener('click', () => {
      document.getElementById('forms-container').innerHTML = '';
    });
  }

  // Adiciona novo cultivo
  addNewCrop() {
    const newCrop = {
      id: this.crops.length + 1,
      name: document.getElementById('new-crop-name').value,
      season: document.getElementById('new-crop-season').value,
      growthDays: parseInt(document.getElementById('new-crop-days').value),
      soilType: document.getElementById('new-crop-soil').value,
      waterNeeds: parseInt(document.getElementById('new-crop-water').value)
    };
    
    this.crops.push(newCrop);
    document.getElementById('forms-container').innerHTML = '';
    this.updateCropSelect();
    alert(`${newCrop.name} adicionado com sucesso!`);
  }

  // Atualiza dropdown de seleção de cultivos
  updateCropSelect() {
    const select = document.getElementById('crop-select');
    if (!select) return;
    
    select.innerHTML = this.crops.map(crop => 
      `<option value="${crop.id}">${crop.name}</option>`
    ).join('');
  }

  // Simula busca de dados meteorológicos
  async fetchWeatherData(location) {
    console.log(`Buscando dados meteorológicos para ${location}...`);
    // Simulação de API - em um projeto real, substituir por chamada real a API de meteorologia
    return new Promise(resolve => {
      setTimeout(() => {
        this.weatherData = {
          location,
          temperature: 25 + Math.floor(Math.random() * 10),
          humidity: 60 + Math.floor(Math.random() * 20),
          precipitation: Math.floor(Math.random() * 50),
          forecast: ['Ensolarado', 'Parcialmente nublado', 'Chuvoso'][Math.floor(Math.random() * 3)]
        };
        resolve(this.weatherData);
      }, 1000);
    });
  }
}

// Inicializa o aplicativo quando o DOM estiver carregado
document.addEventListener('DOMContentLoaded', () => {
  const app = new AgricultureApp();
  
  // Exponha o app no escopo global para acesso via console (para testes)
  window.agricultureApp = app;
  
  // Atualiza seletor de cultivos
  app.updateCropSelect();
  
  // Exemplo de uso da API meteorológica
  document.getElementById('weather-btn')?.addEventListener('click', async () => {
    const location = document.getElementById('location-input').value;
    if (!location) {
      alert('Por favor, insira uma localização.');
      return;
    }
    
    const weatherInfo = await app.fetchWeatherData(location);
    document.getElementById('weather-result').innerHTML = `
      <h3>Previsão para ${weatherInfo.location}</h3>
      <p>Temperatura: ${weatherInfo.temperature}°C</p>
      <p>Umidade: ${weatherInfo.humidity}%</p>
      <p>Precipitação: ${weatherInfo.precipitation}mm</p>
      <p>Condição: ${weatherInfo.forecast}</p>
    `;
  });
});
